#!/bin/bash
# üöÄ setup-github-auto.sh
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —á–µ—Ä–µ–∑ API + –ø—É—à–∏—Ç —á–µ—Ä–µ–∑ SSH.
# –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ gh CLI.
# –¢—Ä–µ–±—É–µ—Ç—Å—è GITHUB_TOKEN (Personal Access Token —Å –ø—Ä–∞–≤–∞–º–∏ `repo`).

set -e

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
GITHUB_HOST="github-work"  # —Ç–≤–æ–π SSH alias (—Å–º. ~/.ssh/config)
USERNAME=""                 # –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—Å—è –ø–æ API
REPO_NAME=""
DESCRIPTION="Autogenerated repository"
PRIVATE=false
CLEAN=false

# === –ü–ê–†–°–ò–ù–ì –ü–ê–†–ê–ú–ï–¢–†–û–í ===
while [[ "$#" -gt 0 ]]; do
  case $1 in
    --name) REPO_NAME="$2"; shift ;;
    --desc) DESCRIPTION="$2"; shift ;;
    --private) PRIVATE=true ;;
    --clean) CLEAN=true ;;
    *) echo "‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1" ;;
  esac
  shift
done

# === –ü–†–û–í–ï–†–ö–ò ===
if [ -z "$GITHUB_TOKEN" ]; then
  echo "‚ùå –ù–µ –∑–∞–¥–∞–Ω GITHUB_TOKEN (Personal Access Token)."
  echo "üëâ –°–æ–∑–¥–∞–π —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ repo –∏ –∑–∞–¥–∞–π: export GITHUB_TOKEN=your_token"
  exit 1
fi

if [ -z "$REPO_NAME" ]; then
  echo "‚ùå –£–∫–∞–∂–∏ –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: --name my-repo"
  exit 1
fi

# === SSH-–î–û–°–¢–£–ü ===
echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é SSH-–¥–æ—Å—Ç—É–ø –∫ $GITHUB_HOST..."
if ! ssh -T "$GITHUB_HOST" 2>&1 | grep -q "successfully authenticated"; then
  echo "‚ö†Ô∏è SSH-–¥–æ—Å—Ç—É–ø –∫ $GITHUB_HOST –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å ~/.ssh/config –∏ –∫–ª—é—á–∏."
  exit 1
fi

# === CLEAN MODE ===
if [ "$CLEAN" = true ]; then
  echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
  rm -rf .git
  git init
else
  [ ! -d .git ] && git init
fi

# === –û–ü–†–ï–î–ï–õ–Ø–ï–ú –ò–ú–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ß–ï–†–ï–ó API ===
echo "üë§ –û–ø—Ä–µ–¥–µ–ª—è—é –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
USERNAME=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user | jq -r .login)
if [ -z "$USERNAME" ] || [ "$USERNAME" = "null" ]; then
  echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–≤–µ—Ä—å GITHUB_TOKEN."
  exit 1
fi

# === –°–û–ó–î–ê–ù–ò–ï –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ===
echo "üì¶ –°–æ–∑–¥–∞—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π '$REPO_NAME' –æ—Ç –∏–º–µ–Ω–∏ $USERNAME..."
CREATE_PAYLOAD=$(jq -n \
  --arg name "$REPO_NAME" \
  --arg desc "$DESCRIPTION" \
  --argjson private $PRIVATE \
  '{name: $name, description: $desc, private: $private}')

CREATE_RESPONSE=$(curl -s -X POST \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  https://api.github.com/user/repos \
  -d "$CREATE_PAYLOAD")

if echo "$CREATE_RESPONSE" | grep -q '"message": "name already exists"'; then
  echo "‚ö†Ô∏è –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π $REPO_NAME —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—É—à."
else
  echo "‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω!"
fi

# === GIT REMOTE ===
REMOTE_URL="$GITHUB_HOST:$USERNAME/$REPO_NAME.git"

git add .
git commit -m "Initial commit" || true
git branch -M main

git remote remove origin 2>/dev/null || true
git remote add origin "$REMOTE_URL"

echo "üì§ –ü—É—à–∏–º –≤ $REMOTE_URL ..."
git push -u origin main

echo "‚úÖ –£—Å–ø–µ—à–Ω–æ! –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å—Å—ã–ª–∫–µ:"
echo "üîó https://github.com/$USERNAME/$REPO_NAME"
